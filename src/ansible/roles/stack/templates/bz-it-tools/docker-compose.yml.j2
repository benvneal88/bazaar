version: "3.8"

services:
{% for service in item.services %}
  {{ service.name }}:
    image: {{ service.image }}
    networks:
      - bz-traefik_{{ swarm_traefik_network_name }}
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.{{ item.stack_name }}.rule=Host(`whoami.local`)"
        - "traefik.http.routers.{{ item.stack_name }}.entrypoints=web"
        - "traefik.http.services.{{ service.name }}.loadbalancer.server.port=80"
      restart_policy:
        condition: unless-stopped
        max_attempts: 3
      replicas: {{ service.replicas }}
  {% endfor %}

networks:
  bz-traefik_{{ swarm_traefik_network_name }}:
    external: true
  